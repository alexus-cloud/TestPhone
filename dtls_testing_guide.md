# Руководство по тестированию и диагностике DTLS в WebRTC

DTLS (Datagram Transport Layer Security) используется в WebRTC для обеспечения безопасности передачи медиаданных (SRTP). Ошибки на этом этапе обычно означают, что сетевое соединение (ICE) установлено, но шифрованный канал не может быть согласован.

## 1. Как работает DTLS в звонке
1. **ICE Gathering**: Поиск путей (IP/Port) для связи.
2. **ICE Connectivity**: Проверка доступности выбранных путей (STUN).
3. **DTLS Handshake**: Установка защищенного соединения поверх успешного ICE-пути.
4. **SRTP**: Начало передачи аудио/видео.

> [!IMPORTANT]
> Если DTLS не проходит, звонок либо останется без звука («silent call»), либо оборвется со статусом `failed`.

---

## 2. Инструменты диагностики

### A. Встроенные логи приложения
Приложение уже настроено на мониторинг состояний. В консоли браузера ищите сообщения:
- `[SipService] DTLS Connection State: ...`
- `[SipService] DTLS Handshake Failed! Check certificates or MTU.`

### B. Chrome WebRTC Internals
Это самый мощный инструмент.
1. Откройте вкладку `chrome://webrtc-internals`.
2. Найдите активное соединение (`PeerConnection`).
3. Ищите график/таблицу **`transport`**:
    - `dtlsState`: должен быть `connected`.
    - `tlsVersion`: обычно `TLS 1.2`.
4. В разделе **`certificate`** можно увидеть хеш сертификата.

---

## 3. Как симулировать ошибки DTLS

Для тестирования обработки ошибок можно использовать следующие методы:

### Метод 1: Ограничение MTU (Наиболее частая реальная причина)
DTLS-пакеты при рукопожатии могут быть большими (из-за сертификатов). Если сеть (или VPN/Firewall) блокирует фрагментированные UDP пакеты, DTLS зависнет.
- **Как симулировать**: Используйте сетевые утилиты (например, в macOS `Network Link Conditioner`) для установки маленького MTU или эмуляции потерь пакетов.

### Метод 2: Блокировка UDP портов после ICE
Если разрешить STUN (порт 3478), но заблокировать диапазон RTP портов (обычно 10000-20000), ICE может пройти (через host-candidates), но DTLS не сможет отправить пакеты.
- **Как симулировать**: Настройте локальный Firewall (pf или iptables), чтобы блокировать UDP трафик на порты медиа-сервера.

### Метод 3: Искусственная задержка (Latency)
Сильная задержка (>1000ms) может приводить к таймаутам DTLS рукопожатия.
- **Как симулировать**: В DevTools -> Network -> Throttling выберите "Slow 3G" (это влияет на WebSocket, но для WebRTC лучше использовать `Network Link Conditioner`).

---

## 4. Интерпретация состояний `dtlsState`

| Состояние | Описание | Что делать |
| :--- | :--- | :--- |
| `new` | Ожидание начала. | Проверьте, начался ли ICE. |
| `connecting` | Идет рукопожатие. | Если висит долго — проблема в MTU или Firewall. |
| `connected` | Соединение установлено. | Все отлично. |
| `failed` | Ошибка рукопожатия. | Проверьте сертификаты или обрыв сети. |
| `closed` | Канал закрыт. | Обычно при завершении звонка. |

---

## 5. Проверка в коде
В файле `src/services/sipService.ts` (метод `monitorPeerConnection`) вы можете добавить искусственный разрыв для теста UI:

```typescript
// Пример для теста: принудительный "сбой" через 2 секунды после начала
pc.onconnectionstatechange = () => {
  if (pc.connectionState === 'connecting') {
    setTimeout(() => {
      // Это только для визуального теста логов/состояний
      console.warn("Simulated DTLS Failure");
    }, 2000);
  }
};
```

---

## 6. Проблема: DTLS connected, но звука нет

Если вы видите `dtlsState: connected`, но звука всё равно нет, обратите внимание на следующие метрики в `chrome://webrtc-internals`:

### А. Счётчик пакетов (Packets)
Посмотрите на таблицу `transport` или `inbound-rtp`:
- `packetsReceived`: Если это число очень маленькое (например, < 50) и не растет, а `packetsSent` тысячи — значит, **вы отправляете звук, но не получаете его**.
- **Причина**: Входящий UDP трафик блокируется Firewall-ом на стороне клиента или ISP. Хотя DTLS handshake (несколько пакетов) прошел, основной поток RTP режется.

### Б. Inbound RTP Stats
Найдите секцию `inbound-rtp` (kind: audio):
- `audioLevel`: Если число `0`, значит в потоке тишина.
- `jitter` и `packetsLost`: Если они высокие, звук будет прерываться или отсутствовать.

### В. ICE Candidate Pair
Проверьте `selected-candidate-pair`:
- Если используется `type: host`, попробуйте протестировать через другой интернет (мобильный) или проверьте настройки STUN/TURN.
- **Symmetric NAT**: Если вы за корпоративным Firewall, вам может быть необходим **TURN сервер** (в текущем конфиге `sipService.ts` только STUN).

---

*Этот гайд поможет вам локализовать проблему между сетевым уровнем (ICE) и уровнем безопасности (DTLS).*
