# SIP WebRTC Troubleshooting Guide (UA)

Цей посібник містить опис технічних проблем, які були виявлені та вирішені під час налаштування SIP-клієнта на базі SIP.js для роботи з сервером Ringotel.

---

## 1. Нестабільне WebSocket з'єднання
**Симптом:** Клієнт постійно перепідключається, статус реєстрації блимає або скидається.
**Рішення:** Додано параметри `keep-alive` для WebSocket.
*   **Чому це важливо:** Браузери та проксі-сервери можуть обривати "тихі" WebSocket з'єднання.
*   **Фікс:**
    ```typescript
    transportOptions: {
      keepAliveInterval: 30, // кожні 30 сек відправляти ping
      keepAliveDebounce: 10
    }
    ```

## 2. Помилки ICE/STUN (Відсутність медіа)
**Симптом:** Дзвінок ініціюється, але медіа-потоки не встановлюються (тиша).
**Рішення:** Налаштування STUN-серверів Google.
*   **Чому це важливо:** WebRTC потребує STUN для проходження крізь NAT.
*   **Фікс:** Додано `iceServers: [{ urls: "stun:stun.l.google.com:19302" }]` у конфігурацію `sessionDescriptionHandlerFactoryOptions`.

## 3. Помилка маршрутизації (404 Not Found)
**Симптом:** Сервер надсилає вхідний виклик, але клієнт відповідає `404 Not Found`.
**Рішення:** Узгодження `contactName` та `viaHost`.
*   **Чому це важливо:** SIP.js створює випадковий хост (наприклад, `random.invalid`). Якщо сервер надсилає `INVITE` на реальний домен компанії, клієнт не впізнає себе в цьому домені.
*   **Фікс:**
    - `contactName`: встановлено на `username`.
    - `viaHost`: встановлено на реальний домен сервера (realm).
    - Це формує коректний заголовок: `Contact: <sip:user@domain.com>`.

## 4. Відсутність звуку при відповіді (488 Not Acceptable)
**Симптом:** Вхідний дзвінок скидається одразу після натискання "Accept".
**Рішення:** Гарантований запит мікрофона перед реєстрацією та відповіддю.
*   **Чому це важливо:** Якщо браузер не має доступу до мікрофона в момент виклику `answer()`, він генерує "порожній" або несумісний SDP, який сервер відхиляє.
*   **Фікс:** Реалізовано перевірку `navigator.mediaDevices.getUserMedia()` перед реєстрацією та перед самою відповіддю на дзвінок.

## 5. Проблема "Ghost" реєстрацій (Дублікати)
**Симптом:** На сервері висить багато активних реєстрацій для одного користувача, через що сервер шле виклики на старі (вже закриті) сесії.
**Рішення:** Стабільний `Instance ID`.
*   **Чому це важливо:** Якщо при кожному оновленні сторінки створюється новий випадковий ID, сервер вважає це новим пристроєм.
*   **Фікс:** `Instance ID` тепер генерується як стабільний хеш на основі `username`. При перезавантаженні сторінки клієнт використовує той самий ID, що дозволяє серверу оновлювати існуючу реєстрацію замість створення нової.

---

## Поточна критична точка (Next Step)

### Помилка: "Called with SDP without DTLS fingerprint"
**Статус:** Вимагає налаштування на стороні сервера.

**Опис:**
Сучасні браузери (Chrome/Edge/Firefox) підтримують WebRTC тільки через шифрування **DTLS** (`a=fingerprint` у SDP). Якщо сервер надсилає застаріле шифрування **SDES** (`a=crypto`), браузер блокує встановлення з'єднання з безпекових міркувань. Помилка `480 Temporarily Unavailable` від клієнта — це автоматична реакція на несумісний медіа-профіль.

**Вимога до сервера:**
У налаштуваннях профілю WebRTC на сервері Ringotel необхідно змінити метод шифрування з **SDES (Crypto)** на **DTLS (Fingerprint)**.
